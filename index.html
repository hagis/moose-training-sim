<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moose Shooting Practice</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    #moose-container {
      position: relative;
      width: 100%;
      height: 300px;
      overflow: hidden;
      border: 1px solid #ccc;
      margin-top: 20px;
      background-color: antiquewhite;
    }
    #moose {
      position: absolute;
      top: 50px;
      left: 0;
      height: auto;
    }
  </style>
</head>
<body>
  <h1>Moose Shooting Practice</h1>
  <form id="settings">
    <label>
      Screen width in cm:
      <input type="number" id="screenWidth" value="94" required />
    </label>
    <br/><br/>
    <button type="submit">Start</button>
  </form>

  <p id="distance-output"></p>

  <div id="moose-container">
    <img id="moose" src="https://metsastajaliitto.fi/sites/default/files/inline-images/SML-Mets%C3%A4styshirviammunta%20taulu.png" alt="Moose" onerror="this.onerror=null; this.src='moose_targets.png';" />
  </div>

  <script>
        const form = document.getElementById('settings');
        const moose = document.getElementById('moose');
        const container = document.getElementById('moose-container');
        const output = document.getElementById('distance-output');

        const waitDuration = 5000; // milliseconds
        const realMooseSpeed = 5.22; // meters per second
        const realTrackWidth = 23; // meters
        const realDistance = 100 // meters
        const realTargetSizeCm = 65 // The outer ring in real cm
        const imageTargetSizePx = 142 // The outer ring in pixels
        const screenWidthPx = container.clientWidth;
        const imageWidthInPixels = 1000

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const screenWidthCm = parseFloat(document.getElementById('screenWidth').value);

            const scaleFactor = (screenWidthCm / 100) / realTrackWidth
            const pixelPerCm = screenWidthPx / screenWidthCm;
            const imageScaleFactor = (realTargetSizeCm * pixelPerCm) / imageTargetSizePx

            // Calculate the proper standing distance
            const distanceM = realDistance * scaleFactor
            output.textContent = `Stand ${(100 * scaleFactor).toFixed(2)} meters from the screen for a 100 m simulation, or  ${(75 * scaleFactor).toFixed(2)} for a 75 m simulation.`;

            const virtualMooseWidthPx = imageWidthInPixels * imageScaleFactor * scaleFactor
            moose.style.width = `${virtualMooseWidthPx}px`;

            // Speed of moose in px/s
            const speed = realMooseSpeed * 100 * pixelPerCm * scaleFactor

            // Animate the moose back and forth with pause
            let position = -virtualMooseWidthPx + 50;
            let direction = 1;
            let lastTime = null;
            let waiting = false;
            let waitStart = null;
            

            function animate(timestamp) {
                if (!lastTime) {
                    lastTime = timestamp;
                    requestAnimationFrame(animate);
                    return;
                }

                const delta = timestamp - lastTime;
                lastTime = timestamp;

                if (waiting) {
                    if (timestamp - waitStart >= waitDuration) {
                        waiting = false;
                        direction *= -1;
                    } else {
                        requestAnimationFrame(animate);
                        return;
                    }
                }

                position += direction * speed * (delta / 1000);

                const leftEdge =  -virtualMooseWidthPx + 50;
                const rightEdge = screenWidthPx + virtualMooseWidthPx - 50;

                if ((direction === 1 && position + virtualMooseWidthPx >= rightEdge) ||
                    (direction === -1 && position <= leftEdge)) {
                    position = direction === 1 ? rightEdge - virtualMooseWidthPx : leftEdge;
                    waiting = true;
                    waitStart = timestamp;
                    console.log(timestamp)
                }

                moose.style.left = `${position}px`;
                requestAnimationFrame(animate);
            }

            requestAnimationFrame(animate);
    });
  </script>
</body>
</html>
